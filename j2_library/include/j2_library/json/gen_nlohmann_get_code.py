#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
gen_nlohmann_get_code.py

기능:
  - JSON 파일을 읽어 키/타입을 재귀 탐색
  - 별칭 규칙에 맞는 C++ 코드 스켈레톤을 생성
    using nj  = nlohmann::json;
    using njj = nlohmann::json::json_pointer;
    namespace jj = j2::json;
  - jj::get_*() 호출 형태의 안전 접근 코드 출력

사용:
  python gen_nlohmann_get_code.py <json_file>

출력 예(C++ code):
  using nj  = nlohmann::json;
  using njj = nlohmann::json::json_pointer;
  namespace jj = j2::json;
  nj j = nj::parse(/* json content */);

  std::string host = jj::get_string(j, "/config/database/host", "default");
  int port = jj::get_int(j, "/config/database/port", 0);
  bool ssl = jj::get_bool(j, "/config/database/ssl", false);
  double timeout = jj::get_double(j, "/config/timeout", 0.0);
"""

import json
import sys

def infer_type(value):
    """JSON 값으로부터 C++ 타입, 기본값, 호출 함수명을 추론합니다."""
    if isinstance(value, bool):
        return "bool", "false", "get_bool"
    if isinstance(value, int):
        return "int", "0", "get_int"
    if isinstance(value, float):
        return "double", "0.0", "get_double"
    if isinstance(value, str):
        # 문자열 기본값은 "default"로 지정 (필요시 옵션화 가능)
        return "std::string", '"default"', "get_string"
    return None, None, None

def sanitize_var(name: str) -> str:
    """C++ 변수명으로 사용할 안전한 식별자로 정제합니다."""
    out = []
    for c in name:
        if c.isalnum() or c == "_":
            out.append(c)
        else:
            out.append("_")
    if out and out[0].isdigit():
        out.insert(0, "_")
    s = "".join(out)
    return s if s else "var"

def traverse(prefix, obj, lines):
    """
    JSON 객체를 재귀 탐색하여 leaf 값에 대해
    jj::get_*() 호출 코드를 생성합니다.
    """
    if isinstance(obj, dict):
        for k, v in obj.items():
            path = f"{prefix}/{k}"
            if isinstance(v, dict):
                traverse(path, v, lines)
            elif isinstance(v, list):
                handle_array(path, v, lines)
            else:
                ty, default, func = infer_type(v)
                if ty:
                    var = sanitize_var(k)
                    lines.append(f"{ty} {var} = jj::{func}(j, \"{path}\", {default});")
    elif isinstance(obj, list):
        handle_array(prefix, obj, lines)

def handle_array(prefix, arr, lines):
    """
    배열은 다음 정책으로 처리합니다:
      - 비어 있으면 코드 생성 생략
      - 첫 원소 타입으로 힌트를 얻어 index 0 접근 예시를 생성
      - (확장 가능) 모든 원소 루프/템플릿 생성은 요구 시 추가 가능
    """
    if not arr:
        return
    ty, default, func = infer_type(arr[0])
    if ty:
        # 변수명은 상위 키 + _0 형태
        key = prefix.split("/")[-1] if "/" in prefix else prefix
        var = sanitize_var(f"{key}_0")
        lines.append(f"{ty} {var} = jj::{func}(j, \"{prefix}/0\", {default});")

def main(filename):
    with open(filename, "r", encoding="utf-8") as f:
        data = json.load(f)

    lines = []
    traverse("", data, lines)

    # 헤더 별칭과 파싱 스켈레톤
    print("// Auto-generated by gen_nlohmann_get_code.py")
    print("using nj  = nlohmann::json;")
    print("using njj = nlohmann::json::json_pointer;")
    print("namespace jj = j2::json;")
    print("nj j = nj::parse(/* json content */);")
    print()

    # 본문 생성
    for ln in lines:
        print(ln)

if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("Usage: python gen_nlohmann_get_code.py <json_file>")
        sys.exit(1)
    main(sys.argv[1])

"""

JSON 파일 예제: example.json
{
  "config": {
    "database": {
      "host": "localhost",
      "port": 3306,
      "ssl": true
    },
    "timeout": 3.5
  }
}

실행 예: python gen_nlohmann_get_code.py example.json

출력 예(C++):
// Auto-generated by gen_nlohmann_get_code.py
using nj  = nlohmann::json;
using njj = nlohmann::json::json_pointer;
namespace jj = j2::json;
nj j = nj::parse(/* json content */);

std::string host = jj::get_string(j, "/config/database/host", "default");
int port = jj::get_int(j, "/config/database/port", 0);
bool ssl = jj::get_bool(j, "/config/database/ssl", false);
double timeout = jj::get_double(j, "/config/timeout", 0.0);

"""



